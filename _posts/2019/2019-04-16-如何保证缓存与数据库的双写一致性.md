---
layout: post
title: 如何保证缓存与数据库的双写一致性？
date: 2019-04-16 14:14:00
author: 薛勤
---
> 问题1：先更新数据库，再删除缓存。如果删除缓存失败了，那么会导致数据库中是新数据，缓存中是旧数据，数据就出现了不一致。

解决思路：**先删除缓存，再更新数据库**。如果数据库更新失败了，那么数据库中是旧数据，缓存中是空的，那么数据不会不一致。因为读的时候缓存没有，所以去读了数据库中的旧数据，然后更新到缓存中。

> 问题2：数据发生了变更，先删除了缓存，然后要去修改数据库，此时还没修改。一个请求过来，去读缓存，发现缓存空了，去查询数据库，**查到了修改前的旧数据**，放到了缓存中。随后数据变更的程序完成了数据库的修改。完了，数据库和缓存中的数据不一样了...

解决思路(1)：写请求**先删除缓存，再去更新数据库，（异步等待段时间)再删除缓存**（成功表示有脏数据出现）。

*这种方案读取快速，但会出现短时间的脏数据。*

解决思路(2)：写请求**先修改缓存为指定值，再去更新数据库，再更新缓存**。读请求过来后，先读缓存，判断是指定值后进入循环状态，等待写请求更新缓存。如果循环超时就去数据库读取数据，更新缓存。

*这种方案保证了读写的一致性，但是读请求会等待写操作的完成，降低了吞吐量*

> 详细参考文章：[https://blog.csdn.net/hukaijun/article/details/81010475](https://blog.csdn.net/hukaijun/article/details/81010475)

